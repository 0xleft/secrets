{% extends "layout.html" %}
{% block content %}

<section class="section">
    <div class="container">
        <h1 class="title is-1">Admin</h1>
        <p class="subtitle">
            For me :)
        </p>
    </div>

</section>

<section class="section">
    <nav class="level">
        <div class="level-item has-text-centered">
            <div>
                <p class="heading">User count</p>
                <p class="title">{{ users.__len__() }}</p>
            </div>
        </div>
        <div class="level-item has-text-centered">
            <div>
                <p class="heading">Secret count</p>
                <p class="title">{{ info["secret_count"] }}</p>
            </div>
        </div>
        <div class="level-item has-text-centered">
            <div>
                <p class="heading">Repository count</p>
                <p class="title">{{ info["repo_count"] }}</p>
            </div>
        </div>
        <div class="level-item has-text-centered">
            <div>
                <p class="heading">Latest ID</p>
                <p class="title">{{ info["latest_id"] }}</p>
            </div>
        </div>
    </nav>
</section>

<section class="section">
    <div class="container">
        <h2 class="title">Users</h2>
        <p class="subtitle">
            Here are the users that have registered.
        </p>

        <form action="/secrets/admin" method="post">
            <div class="field">
                <label class="label">Username</label>
                <div class="control">
                    <input class="input" type="text" name="username" placeholder="Username" value="{{ search if search else '' }}">
                </div>
            </div>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="search" value="1">
            <div class="field">
                <div class="control">
                    <button class="button is-info">Search</button>
                </div>
            </div>
        </form>

        <br>

        <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Api key</th>
                    <th>Api key uses left</th>
                    <th>Created at</th>
                    <th>Is deleted</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                    <tr>
                        <td>{{ user["login"] }}</td>
                        <td>{{ user["email"] }}</td>
                        <td>{{ user["api_key"][:10] }}...</td>
                        <td>{{ user["api_key_uses_left"] }}</td>
                        <td>{{ user["created_at"] }}</td>
                        <td>{{ user["is_deleted"] }}</td>

                        <td>
                            <form action="/secrets/admin" method="post">
                                <input type="hidden" name="reset_key_uses" value="{{ user['id'] }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button class="button is-success">Reset key</button>
                            </form>
                        </td>

                        <td>
                            <form action="/secrets/admin" method="post">
                                <input type="hidden" name="end_key_uses" value="{{ user['id'] }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button class="button is-danger">End key</button>
                            </form>
                        </td>

                        <td>
                            <form action="/secrets/admin" method="post">
                                <input type="hidden" name="delete_user" value="{{ user['id'] }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button class="button is-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="container">
            <nav class="pagination is-centered" role="navigation" aria-label="pagination">
                <a class="pagination-previous">Previous</a>
                <a class="pagination-next">Next page</a>

                <ul class="pagination-list">
                    <li><a class="pagination-link" aria-label="Goto page {{ page + 5 if page + 5 < page_end else page_end }}">{{ page - 5 if page - 5 > 0 else 0 }}</a></li>
                    <li><a class="pagination-link is-current" aria-label="Page 46" aria-current="page">{{ page }}</a></li>
                    <li><a class="pagination-link" aria-label="Goto page {{ page + 5 if page + 5 < page_end else page_end }}">{{ page + 5 if page + 5 < page_end else page_end }}</a></li>
                </ul>
            </nav>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const $paginationPrevious = document.querySelector('.pagination-previous');
                const $paginationNext = document.querySelector('.pagination-next');

                $paginationPrevious.addEventListener('click', () => {
                    $.ajax({
                        url: '/secrets/admin',
                        type: 'post',
                        data: {
                            page: '{{ page - 1 }}',
                            username: '{{ search }}',
                            csrf_token: '{{ csrf_token() }}'
                        },
                    });
                });

                $paginationNext.addEventListener('click', () => {
                    $.ajax({
                        url: '/secrets/admin',
                        type: 'post',
                        data: {
                            page: '{{ page + 1 }}',
                            username: '{{ search }}',
                            csrf_token: '{{ csrf_token() }}'
                        },
                    });
                });
            });
        </script>
    </div>
</section>

<section class="section">
    <div class="container">
        <h2 class="title">Danger</h2>
        <p class="subtitle">
            Be careful please :)
        </p>

        <div class="container">
            <form action="/secrets/admin" method="post">
                <input type="hidden" name="delete_all_users" value="1">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="button is-danger">Delete all users</button>
            </form>
    
            <form action="/secrets/admin" method="post">
                <input type="hidden" name="delete_all_secrets" value="1">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="button is-danger">Delete all secrets</button>
            </form>
        </div>

    </div>
</section>

{% endblock content %}